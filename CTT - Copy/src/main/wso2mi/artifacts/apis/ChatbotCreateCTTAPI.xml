<?xml version="1.0" encoding="UTF-8"?>
<api context="/chatbotcreatecttapi" name="ChatbotCreateCTTAPI" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="POST" uri-template="/createCTT">
        <inSequence>
            <log level="full">
                <property name="RequestPayload" expression="json-eval($.)"/>
            </log>
            <!-- Extract values from the incoming request -->
            <property name="requestId" expression="json-eval($.requestHeader.requestId)" scope="default"/>
            <property name="eventName" expression="json-eval($.requestHeader.eventName)" scope="default"/>
            <property name="mobileNum" expression="json-eval($.mobileNum)" scope="default"/>
            <property name="createCtt" expression="json-eval($.createCtt)" scope="default"/>
            <property name="reason" expression="json-eval($.reason)" scope="default"/>
            <property name="comment" expression="json-eval($.comment)" scope="default"/>
            <property name="responseDt" expression="json-eval($.responseDt)" scope="default"/>
            <filter regex="Chatbot-001" source="get-property('requestId')">
                <then>
                    <log level="full">
                        <property name="RequestIdCheck" value="RequestId is Chatbot-001"/>
                    </log>
                    <filter regex="Yes" source="get-property('createCtt')">
                        <then>
                            <property name="dynamicCttNo" expression="fn:concat('Test-', get-property('messageID'))" scope="default"/>
                            <payloadFactory media-type="json" template-type="default">
                                <format>{
                                    "proactiveCttInfo": {
                                    "cttNo": "$1",
                                    "validityFlag": "Valid"
                                    }
                                    }</format>
                                <args>
                                    <arg expression="get-property('dynamicCttNo')"/>
                                </args>
                            </payloadFactory>
                        </then>
                        <else>
                            <payloadFactory media-type="json" template-type="default">
                                <format>{
                                    "proactiveCttInfo": {
                                    "validityFlag": "Y"
                                    }
                                    }</format>
                                <args></args>
                            </payloadFactory>
                        </else>
                    </filter>
                </then>
                <else>
                    <payloadFactory media-type="json" template-type="default">
                        <format>{
                            "responseHeader": {
                            "rqUuid": "urn:uuid:028d9b99-22c6-4443-bc77-61776a99833a",
                            "requestId": "Chatbot-001",
                            "status": "Error",
                            "statusCode": 1,
                            "errorCode": "WSO2000004",
                            "errorMessage": "Duplicate Request Id",
                            "errorDetail": "Duplicated Field Value : Request Id",
                            "errorPayload": ""
                            }
                            }</format>
                        <args></args>
                    </payloadFactory>
                </else>
            </filter>
            <respond/>
        </inSequence>
    </resource>
</api>
